<!DOCTYPE html>
<html>
<head>
    <title>Rovio mobile</title>
    <script type="text/javascript" src="app/javascript/prototype.js"></script>
    <script type="text/javascript" src="app/javascript/scriptaculous.js"></script>
    <script type="text/javascript" src="app/javascript/rovio.js"></script>
    <script type="text/javascript" src="app/javascript/screenfull.js"></script>
    <script type="text/javascript">
    // <![CDATA[
        var hHeight, bHeight, slide, speed, direction, lastDirection = 'stop_moving';
		speed=1;
        
        $(document).observe('keydown', function (e) {
        	var is_hotkey = true; 
        	var is_rotkey = false;
    		switch (e.keyCode) {
        		case Event.KEY_LEFT:
        			direction = 'move_left';
            		break;
        		case Event.KEY_RIGHT:
        			direction = 'move_right';
            		break;
            	case Event.KEY_DOWN:
            		direction = 'move_back';
            		break;
            	case Event.KEY_UP:
            		direction = 'move_forward';
            		break;
            	case 65:	//A
        			direction = 'move_left';
            		break;
        		case 68:	//D
        			direction = 'move_right';
            		break;
            	case 83:	//S
            		direction = 'move_back';
            		break;
            	case 87:	//W
            		direction = 'move_forward';
            		break;
            	case 81:	//Q
            		direction = 'rot_left';
            		is_rotkey = true;
            		break;
            	case 69:	//E
            		direction = 'rot_right'
            		is_rotkey = true;
            		break; 
            	default:
            		is_hotkey = false;
            	}
//            console.log(e.keyCode);
//            console.log(direction);
            if (speed != 1 && (is_moving == 0 || direction!=lastDirection)){
            	
            	stopMoving();
            	startMoving(direction, speed);
            	lastDirection = direction;
            	is_moving = 1;
            	logAction('start');
            }
            	var image_url_part;
            	var button_name;
            	switch (direction){
            		case 'move_left':
            			image_url_part = 'left';
            			button_name = 'strifeleft';
            			break;
            		case 'move_right':
            			image_url_part = 'right';
            			button_name = 'striferight';
            			break;
            		case 'move_forward':
            			image_url_part = 'forward';
            			button_name = 'forward';
            			break;
            		case 'move_back':
            			image_url_part = 'backward';
            			button_name = 'backward';
            			break;
            		case 'rot_left':
            			image_part_url = 'left';
            			button_name = 'rotate_left';
            			break;
            		case 'rot_right':
            			image_part_url = 'right';
            			button_name = 'rotate_right';
            			break;
            	}
            	if (is_hotkey){
            		if (is_rotkey){
            			setButtonDown2(button_name, image_part_url, 0, 62)
            		}
            		else{
            			$(button_name).setStyle({backgroundImage: 'url(images/'+image_url_part+'_on.png)'})
            		}
            		
            	}
            
      });
   
		$(document).observe('keyup', function(e){
			if (((e.keyCode == Event.KEY_LEFT || e.keyCode == 65) && direction == 'move_left') ||
				 ((e.keyCode == Event.KEY_RIGHT || e.keyCode == 68) && direction == 'move_right') ||
				 ((e.keyCode == Event.KEY_UP || e.keyCode == 87) && direction == 'move_forward') || 
				 ((e.keyCode == Event.KEY_DOWN || e.keyCode == 83) && direction == 'move_back') ||
				 (e.keyCode == 81 && direction == 'rot_left') ||
				 (e.keyCode == 69 && direction == 'rot_right')){
         		stopMoving();
         		is_moving = 0;
         		lastDirection = 'stop_moving';
         		setAllButtonsUp('forward', 'forward', 'strifeleft', 'left', 'striferight', 'right', 'backward', 'backward', 'rotate_left', 'left', 'rotate_right', 'right');
         	}
         });
		 
        function setBgPos(v) {
            var off = v * hHeight;
            var pos = -bHeight + (v * bHeight);
            //$('slider').setStyle({backgroundPosition: 0 Math.round(pos - off) + 'px'});
			$('debug').innerHTML = v;
        }
        
        function setSlideOutput(v) {
            $('percent').update(100-Math.round(v * 100) + '%');
            if (100-Math.round(v * 100) == 0){
            	stopMoving();
            }
            else{
				speed = v*10;
			}
        }
        
		function processAccelerometer(accelerationX, accelerationY, accelerationZ)
		{
			direction = 'stop_moving';	// stop if tablet in lying position
			if(accelerationX > 2) direction = 'move_forward';	// forward
			if(accelerationX < -2) direction = 'move_back'; 	// backward
			if(accelerationY > 2) direction = 'move_left'; 		// left
			if(accelerationY < -2) direction = 'move_right'; 	// right
			if((accelerationX > 2)&&(accelerationY > 2)) direction = 'move_fwd_left';		// forward left
			if((accelerationX > 2)&&(accelerationY < -2)) direction = 'move_fwd_right';	// forward right
			if((accelerationX < -2)&&(accelerationY > 2)) direction = 'move_bck_left';		// forward left
			if((accelerationX < -2)&&(accelerationY < -2)) direction = 'move_bck_right';	// forward right
			// logAction('AX='+accelerationX+"dir="+direction);
			if(direction!='stop_moving') 
			{
				if((is_moving==0)||(direction!=lastDirection))
				{
					stopMoving();
					startMoving(direction,speed);
				}
			}
			else stopMoving();
			lastDirection = direction;
		}
		
        Event.observe(window, 'load', function() {		
			Event.observe('camera_container', 'DOMMouseScroll', wheel); // mozilla
			Event.observe('camera_container', 'mousewheel', wheel);	// IE/Opera
			
//			window.addEventListener('deviceorientation', function(e) {
//				logAction(e.webkitCompassHeading);
//			}, false);

		    window.ondevicemotion = function(event) {  
				var accelerationX = event.accelerationIncludingGravity.x;  
				var accelerationY = event.accelerationIncludingGravity.y;  
				var accelerationZ = event.accelerationIncludingGravity.z; 
				processAccelerometer(accelerationX, accelerationY, accelerationZ);
			}  
			
			screenfull.onchange = function() {
				if(screenfull.isFullscreen==false) //&&(EnteringFullscreen==false)) 
				{
					FullScreenSlide.setValue(0.1);
				}
			}
			
			screenfull.onerror = function() {
				alert("Fullscreen API error");
			}
            hWidth = $('slider-handle').getHeight();
            bWidth = $('slider-bar').getHeight();
            slide = new Control.Slider('slider-handle', 'slider-bar', {
				axis: 'vertical',
                sliderValue: 1,
				values: [0,0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1],
                onSlide: 
                    function(v) {
                        setBgPos(v);
                        setSlideOutput(v);
                    },
                onChange:
                    function(v) {
                        setBgPos(v);
                        setSlideOutput(v);
                    }
            });
            setBgPos(slide.value);
            setSlideOutput(slide.value);
			
            slide2 = new Control.Slider('camvid-slider-handle', 'camvid-slider-bar', {
				axis: 'horizontal',
                sliderValue: 1,
				values: [0.1,0.9],
                onSlide: 
                    function(v) {
                    },
                onChange:
                    function(v) {
                    }
            });

            FullScreenSlide = new Control.Slider('fullscreen-slider-handle', 'fullscreen-slider-bar', {
				axis: 'horizontal',
                sliderValue: 0.1,
				values: [0.1,0.9],
                onSlide: 
                    function(v) {
                    },
                onChange:
                    function(v) {
						if(v==0.9) screenfull.request();
						if(v==0.1) screenfull.exit();
                    }
            });
			
        });
		
		function logAction(Action) {
			$('debug').update(Action);
		}
		
		function setButtonDown(button, direction) {
			$(button).setStyle({backgroundImage: 'url(images/'+direction+'_on.png)'});
			if (speed != 1){
				if(direction=='forward') startMoving('move_forward',speed);
				if(direction=='backward') startMoving('move_back',speed);
				if(direction=='left') startMoving('move_left',speed);
				if(direction=='right') startMoving('move_right',speed);
				logAction('start');
			}
		}
		
		// this image sprite based function should replace setButtonDown
		function setButtonDown2(button, direction, xpoz, ypoz) {
			$(button).setStyle({background: 'url(images/rotate_'+direction+'.png) '+xpoz+' '+ypoz+'px'});
			startMoving("rot_"+direction,turn_speed);
		}
		
		function setButtonUp(button, direction) {
			$(button).setStyle({backgroundImage: 'url(images/'+direction+'_off.png)'});
			stopMoving();
			logAction('end 1');
		}
		
		function setButtonUp2(button, direction) {
			$(button).setStyle({background: 'url(images/rotate_'+direction+'.png)'});
			stopMoving();
			logAction('end 1');
		}

		function setAllButtonsUp(button1, direction1, button2, direction2, button3, direction3, button4, direction4, 
				button5, direction5, button6, direction6) {
			$(button1).setStyle({backgroundImage: 'url(images/'+direction1+'_off.png)'});
			$(button2).setStyle({backgroundImage: 'url(images/'+direction2+'_off.png)'});
			$(button3).setStyle({backgroundImage: 'url(images/'+direction3+'_off.png)'});
			$(button4).setStyle({backgroundImage: 'url(images/'+direction4+'_off.png)'});
			setButtonUp2(button5, direction5);
			setButtonUp2(button6, direction6);
			stopMoving();
			logAction('end 2');
		}

		
		// mouse wheel code from http://adomas.org/javascript-mouse-wheel/
		function handle(delta) {
			slide.setValueBy(-delta);
		}

			/** Event handler for mouse wheel event. */
		function wheel(event){
			var delta = 0;
			if (!event) /* For IE. */
				event = window.event;
			if (event.wheelDelta) { /* IE/Opera. */
				delta = event.wheelDelta/1200;
				/** In Opera 9, delta differs in sign as compared to IE. */
				if (window.opera)
					delta = -delta;
			} else if (event.detail) { /** Mozilla case. */
				/** In Mozilla, sign of delta is different than in IE.
				* Also, delta is multiple of 3.
				*/
				delta = -event.detail/21;
			}
		
			/** If delta is nonzero, handle it.
			* Basically, delta is now positive if wheel was scrolled up,
			* and negative, if wheel was scrolled down.
			*/
			if (delta)
				handle(delta);
		
			/** Prevent default actions caused by mouse wheel.
			* That might be ugly, but we handle scrolls somehow
			* anyway, so don't bother here..
			*/
			if (event.preventDefault)
				event.preventDefault();
				
			event.returnValue = false;
		}
		
    // ]]>
    </script>
	<!-- TODO : Style sheets code -->
	<link rel="stylesheet" href="app/stylesheets/Main.css" type="text/css">
	<link rel="stylesheet" href="app/stylesheets/slider.css" type="text/css">

</head>

<!-- <body onload="init(); resizeCamera();" onResize="resizeCamera();"> -->
<body onload="init();resizeCamera();" onunload="closeStream();" onResize="resizeCamera();">
<a id="fake_link" href="" onclick="return false"></a>
<div id="camera_container">
</div>
<div id="camera_container2" ontouchmove="event.preventDefault();" style="background-size: 100% 100%;" onmouseup="setAllButtonsUp('forward', 'forward', 'strifeleft', 'left', 'striferight', 'right', 'backward', 'backward', 'rotate_left', 'left', 'rotate_right', 'right');">
	<div id="slider">
		<div id="slider-bar">
			<div id="slider-handle"><p id="percent"></p></div>
		</div>
	</div>
	<div id="fullscreen-slider">
		<div id="fullscreen-slider-bar">
			<div id="fullscreen-slider-handle"><p></p></div>
		</div>
	</div>
	<div id="camvid-slider">
		<div id="camvid-slider-bar">
			<div id="camvid-slider-handle"><p></p></div>
		</div>
		<div id="camvid-capture">
		</div>
	</div>
	<div id="controller">
		<div id="forward" 
			ontouchstart="event.preventDefault(); setButtonDown('forward', 'forward');" ontouchend="event.preventDefault(); setButtonUp('forward', 'forward');" 
			onmousedown="setButtonDown('forward', 'forward');" onmouseup="setButtonUp('forward', 'forward');"></div>
		<div id="strifeleft" 
			ontouchstart="event.preventDefault(); setButtonDown('strifeleft', 'left');" ontouchend="event.preventDefault(); setButtonUp('strifeleft', 'left');" 
			onmousedown="setButtonDown('strifeleft', 'left');" onmouseup="setButtonUp('strifeleft', 'left');"></div>
		<div id="striferight" 
			ontouchstart="event.preventDefault(); setButtonDown('striferight', 'right');" ontouchend="event.preventDefault(); setButtonUp('striferight', 'right');" 
			onmousedown="setButtonDown('striferight', 'right');" onmouseup="setButtonUp('striferight', 'right');"></div>
		<div id="backward" 
			ontouchstart="event.preventDefault(); setButtonDown('backward', 'backward');" ontouchend="event.preventDefault(); setButtonUp('backward', 'backward');" 
			onmousedown="setButtonDown('backward', 'backward');" onmouseup="setButtonUp('backward', 'backward');"></div>
        <div id="joystick_box">
            <div id="joystick"></div>
        </div>	
	</div>
	<div id="rotate_buttons">
		<div id="rotate_left" 
			ontouchstart="event.preventDefault(); setButtonDown2('rotate_left', 'left', 0, 62);" ontouchend="event.preventDefault(); setButtonUp2('rotate_left', 'left', 0, 0);" 
			onmousedown="setButtonDown2('rotate_left', 'left', 0, 62);" onmouseup="setButtonUp2('rotate_left', 'left', 0, 0);"></div>
		<div id="rotate_right" 
			ontouchstart="event.preventDefault(); setButtonDown2('rotate_right', 'right', 0, 62);" ontouchend="event.preventDefault(); setButtonUp2('rotate_right', 'right', 0, 0);" 
			onmousedown="setButtonDown2('rotate_right', 'right', 0, 62);" onmouseup="setButtonUp2('rotate_right', 'right', 0, 0);"></div>
	</div>
</div>

<div id="debug">Debug:</div>
<div id="hiddenFrame" style="display:none;"><iframe id="fakedframe" name="fakedframe" style="display:none;" src="" /></div>

</body>
</html>
